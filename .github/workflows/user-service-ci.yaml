name: User-Service CI

on:
  push:
    paths:
      - "services/user-service/**"
  workflow_dispatch:
  
jobs:
  ci:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: test
    steps:
     - name: Checkout code
       uses: actions/checkout@v4
    
     - name: Setup Node.js
       uses: actions/setup-node@v4
       with: 
        node-version: 22
        cache: npm
      # Install dep
     - name: Install Dependencies
       working-directory: services/user-service
       run: npm ci

     - name: Build Project
       working-directory: services/user-service
       run: |
        npm run build  

     - name: Run tests
       working-directory: services/user-service
       run: |
        npm start &
         sleep 5

     - name: Health check endpoint
       run: |
          curl -f http://localhost:5000/try
  cd-build:
    permissions:
      id-token: write
      contents: read
    needs: ci
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set Up Docker
        uses: docker/setup-buildx-action@v3

      - name: Debug Docker context
        run : |
         pwd
         ls
         ls services
         ls services/user-service
       
      - name: Build Docker Image
        working-directory: ./services/user-service
        run: |
          docker build -t user-service:ci-test .

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with: 
          role-to-assume: ${{secrets.AWS_ROLE}}
          aws-region: eu-north-1
      
      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & push Docker Image
        working-directory: services/user-service
        env:
          ECR_REGISTRY: ${{steps.login-ecr.outputs.registry}}
          IMAGE_TAG: ${{github.sha}}
        run: |
          IMAGE=${{github.sha}}
          ECR_REPO=user-service
          docker build -t $ECR_REPO:IMAGE .
          docker tag $ECR_REPO:$IMAGE $ECR_REGISTRY/$ECR_REPO:$IMAGE
          docker push $ECR_REGISTRY/$ECR_REPO:$IMAGE

          